<!-- templates/usr/pet/ocr.html -->
<!-- ✅ 테스트 업로드 페이지: 파일 선택 → /api/ocr/extract 로 POST 전송 -->
<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8" />
<title>OCR 테스트</title>

<!-- ✅ (권장) Spring Security CSRF 대응: POST 호출 시 토큰 헤더로 전송 -->
<!-- 🔧 [변경] Security 6.x 환경에서 _csrf가 null일 수 있으므로, 클래스명으로 안전 접근 + 조건부 렌더링 -->
<th:block th:with="csrf=${#request.getAttribute('org.springframework.security.web.csrf.CsrfToken')}"
	th:if="${csrf != null}">
	<meta name="_csrf" th:content="${csrf.token}" />
	<meta name="_csrf_header" th:content="${csrf.headerName}" />
</th:block>
<!-- 참고: 위 블록은 _csrf가 없을 때는 아무것도 렌더하지 않으므로 Thymeleaf 파싱 오류가 발생하지 않습니다. -->

<style>
body {
	font-family: system-ui, Arial, sans-serif;
	padding: 16px;
}

#out {
	white-space: pre-wrap;
	border: 1px solid #ddd;
	padding: 12px;
	margin-top: 12px;
}
</style>
</head>
<body>
	<h2>영수증 OCR 테스트</h2>

	<!-- ✅ 파일 업로드 UI (필드명은 반드시 'file') -->
	<input id="file" type="file" accept="image/*" />
	<button id="run" type="button">OCR 실행</button>
	<button id="btnSaveOcr" type="button">OCR 저장</button>
	<div id="out" aria-live="polite"></div>

	<script>
  // =========================
  // ✅ 전역 상태: 마지막 OCR 텍스트/파일 URL
  // =========================
  let __lastOcrText = null;      // OCR 실행 성공 시 저장
  let __uploadedFileUrl = null;  // (선택) 이미지 업로드 URL 보관용

  // =========================
  // ✅ CSRF 메타에서 토큰 추출 (없으면 null 반환)
  // =========================
  function getCsrf() {
    const tokenTag  = document.querySelector('meta[name="_csrf"]');
    const headerTag = document.querySelector('meta[name="_csrf_header"]');
    return (tokenTag && headerTag && tokenTag.content && headerTag.content)
      ? { header: headerTag.content, token: tokenTag.content }
      : null;
  }

  // =========================
  // ✅ URL 쿼리 파서 (예: /usr/pet/ocr?petId=1&visitId=10)
  // =========================
  function getQueryParam(name) {
    const p = new URLSearchParams(location.search);
    return p.get(name);
  }

  // =========================
  // ✅ DOM 참조
  // =========================
  const $file = document.getElementById('file');
  const $out  = document.getElementById('out');

  // =========================
  // ✅ OCR 실행: /api/ocr/extract 로 파일 업로드
  // =========================
  document.getElementById('run').onclick = async () => {
    const f = $file.files?.[0];
    if (!f) { alert('이미지를 선택하세요.'); return; }

    // 1) FormData 구성 (서버 @RequestParam("file")와 필드명 일치)
    const form = new FormData();
    form.append('file', f);

    // 2) CSRF 헤더(있을 때만)
    const headers = {};
    const csrf = getCsrf();
    if (csrf) headers[csrf.header] = csrf.token;

    // 3) 요청
    $out.textContent = '업로드 중...';
    try {
      const res = await fetch('/api/ocr/extract', { method: 'POST', body: form, headers });
      if (!res.ok) {
        const text = await res.text().catch(() => '');
        throw new Error(`HTTP ${res.status} ${res.statusText}${text ? ' - ' + text : ''}`);
      }
      const json = await res.json(); // { resultCode, msg, data1?, data?, text? ... }

      // 4) 화면 출력
      $out.textContent = JSON.stringify(json, null, 2);

      // 5) 텍스트 추출 보관(서버 응답 구조에 따라 안전 탐색)
      __lastOcrText = (json?.data1?.text) || (json?.data?.text) || (json?.text) || null;
      if (!__lastOcrText) {
        console.warn('응답에서 OCR 텍스트를 찾지 못했습니다. 응답 구조를 확인하세요.');
      }
    } catch (e) {
      console.error(e);
      $out.textContent = '요청 실패: ' + (e?.message || e);
    }
  };

  // =========================
  // ✅ OCR 저장: /api/ocr/save 로 JSON POST
  // =========================
  async function saveOcr() {
    if (!__lastOcrText || !__lastOcrText.trim()) {
      alert('저장할 OCR 텍스트가 없습니다. 먼저 [OCR 실행]을 눌러주세요.');
      return;
    }

    // visitId가 있으면 해당 방문에 문서 추가, 없으면 petId로 새 visit 생성
    const petId   = getQueryParam('petId')   ? Number(getQueryParam('petId'))   : null;
    const visitId = getQueryParam('visitId') ? Number(getQueryParam('visitId')) : null;

    const payload = {
      text: __lastOcrText,
      visitId: visitId || null,
      petId: visitId ? null : petId,     // visitId 없을 때만 petId 사용
      docType: 'receipt',                // receipt | prescription | lab | diagnosis | other
      fileUrl: __uploadedFileUrl || null // 선택
      // 필요 시 visitDate/hospital/doctor/diagnosis/notes 추가
    };

    // CSRF 헤더(있을 때만)
    const headers = { 'Content-Type': 'application/json' };
    const csrf = getCsrf();
    if (csrf) headers[csrf.header] = csrf.token;

    try {
      const res = await fetch('/api/ocr/save', {
        method: 'POST',
        headers,
        body: JSON.stringify(payload)
      });
      const json = await res.json();

      if (json?.resultCode?.startsWith('S-')) {
        const { visitId, documentId } = json.data || {};
        alert(`저장 완료!\nvisitId=${visitId}, documentId=${documentId}`);
        // 필요 시 상세로 이동:
        // location.href = `/usr/visit/detail?id=${visitId}`;
      } else {
        console.error('OCR 저장 실패:', json);
        alert(`저장 실패: ${json?.msg || '서버 오류'}`);
      }
    } catch (e) {
      console.error(e);
      alert('저장 중 오류가 발생했습니다.');
    }
  }

  // =========================
  // ✅ 버튼 바인딩
  // =========================
  document.getElementById('btnSaveOcr')?.addEventListener('click', saveOcr);
</script>


</body>
</html>
