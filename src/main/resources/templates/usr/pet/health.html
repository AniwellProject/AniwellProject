<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>무게 변화량 차트</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #fdfae9; }
    canvas { background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
<h2>🪶 사료 무게 변화량</h2>
<canvas id="weightChart" width="800" height="400"></canvas>

<script th:inline="javascript">
  const rawData = /*[[${logs}]]*/ [];
  const petId = /*[[${petId}]]*/ 0;

  const labels = [];
  const deltas = [];
  const bgColors = [];
  const tooltipLabels = [];

  if (rawData.length < 2) {
    alert('데이터가 부족합니다.');
  } else {
    rawData.sort((a, b) => new Date(a.logDate) - new Date(b.logDate));

    for (let i = 1; i < rawData.length; i++) {
      const prev = rawData[i - 1];
      const curr = rawData[i];
      const diff = parseFloat(curr.foodWeight) - parseFloat(prev.foodWeight);
      const absDiff = Math.abs(diff).toFixed(2);

      const timeLabel = new Date(curr.logDate).toTimeString().slice(0, 5);
      labels.push(timeLabel);
      deltas.push(absDiff);

      if (diff < 0) {
        bgColors.push('rgba(76, 175, 80, 0.2)');
        tooltipLabels.push(`급식: ${absDiff}g`);
      } else {
        bgColors.push('rgba(255, 165, 0, 0.2)');
        tooltipLabels.push(`섭취: ${absDiff}g`);
      }
    }
  }

  // ✅ 차트 전역 변수 선언
  const ctx = document.getElementById('weightChart').getContext('2d');
  const weightChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: '사료 변화량 (절대값)',
        data: deltas,
        backgroundColor: bgColors,
        borderColor: bgColors.map(c => c.replace('0.2', '1')),
        borderWidth: 1
      }]
    },
    options: {
      responsive: false,
      scales: {
        y: { title: { display: true, text: 'g' }},
        x: { title: { display: true, text: '시간 (HH:MM)' }}
      },
      plugins: {
        tooltip: {
          callbacks: {
            label: (context) => tooltipLabels[context.dataIndex]
          }
        }
      }
    }
  });

  // ✅ WebSocket 연결
  const socket = new SockJS('/ws');
  const stompClient = Stomp.over(socket);

  stompClient.connect({}, () => {
    console.log("🔌 WebSocket 연결됨");

    stompClient.subscribe(`/topic/health/${petId}`, (message) => {
      const newLog = JSON.parse(message.body);
      const last = rawData[rawData.length - 1];

      const diff = parseFloat(newLog.foodWeight) - parseFloat(last.foodWeight);
      const absDiff = Math.abs(diff).toFixed(2);
      const timeLabel = new Date(newLog.logDate).toTimeString().slice(0, 5);

      // 배열 갱신
      rawData.push(newLog);
      labels.push(timeLabel);
      deltas.push(absDiff);
      if (diff < 0) {
        bgColors.push('rgba(76, 175, 80, 0.2)');
        tooltipLabels.push(`급식: ${absDiff}g`);
      } else {
        bgColors.push('rgba(255, 165, 0, 0.2)');
        tooltipLabels.push(`섭취: ${absDiff}g`);
      }

      // 차트 업데이트
      weightChart.update();
    });
  });
</script>
</body>
</html>
