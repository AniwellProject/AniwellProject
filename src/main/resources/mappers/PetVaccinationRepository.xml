<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.RSW.repository.PetVaccinationRepository">

    <!-- 펫 ID로 접종 이력 조회 -->
    <select id="getVaccinationByPetId" parameterType="int" resultType="com.example.RSW.vo.PetVaccination">
        SELECT
            pv.id,
            pv.petId,
            pv.vaccineName,
            pv.injectionDate,
            pv.nextDueDate,
            pv.vetName,
            pv.notes
        FROM pet_vaccination pv
        WHERE pv.petId = #{petId}
        ORDER BY pv.injectionDate DESC
    </select>

    <select id="findByPetIdAndMonth" resultType="PetVaccination">
        SELECT *
        FROM pet_vaccination
        WHERE petId = #{petId}
          AND DATE_FORMAT(injectionDate, '%Y-%m') = #{yearMonth}
        ORDER BY injectionDate ASC
    </select>

    <!-- 백신 삭제 -->
    <delete id="deletePetVaccination" parameterType="int">
        DELETE FROM pet_vaccination WHERE id = #{id}
    </delete>

    <!-- 백신 등록 -->
    <insert id="insertVaccination" parameterType="map">
        INSERT INTO pet_vaccination (petId, vaccineName, injectionDate)
        VALUES (#{petId}, #{vaccineName}, #{injectionDate})
    </insert>

    <insert id="insertPetVaccinationWithNotes" parameterType="map">
        INSERT INTO pet_vaccination (petId, vaccineName, injectionDate,notes)
        VALUES (#{petId}, #{vaccineName}, #{injectionDate}, #{notes})
    </insert>

    <!-- 백신 수정 -->
    <update id="updatePetVaccination" parameterType="map">
        UPDATE pet_vaccination
        SET vaccineName = #{vaccineName}, injectionDate = #{injectionDate}
        WHERE id = #{vaccinationId}
    </update>

    <update id="updatePetVaccinationWithNotes" parameterType="map">
        UPDATE pet_vaccination
        SET vaccineName = #{vaccineName}, injectionDate = #{injectionDate}, notes = #{notes}
        WHERE id = #{vaccinationId}
    </update>

    <!-- 백신 ID로 조회 -->
    <select id="getVaccinationById" parameterType="int" resultType="com.example.RSW.vo.PetVaccination">
        SELECT
            pv.id,
            pv.petId,
            pv.vaccineName,
            pv.injectionDate,
            pv.nextDueDate,
            pv.vetName,
            pv.notes
        FROM pet_vaccination pv
        WHERE pv.id = #{vaccinationId}
    </select>

    <select id="getPetIdById" parameterType="int" resultType="int">
        SELECT petId
        FROM pet_vaccination
        WHERE id = #{vaccinationId}
    </select>

    <update id="invalidateNextDueDates">
        UPDATE pet_vaccination
        SET nextDueDate = NULL
        WHERE petId = #{petId}
          AND vaccineName = #{vaccineName}
    </update>

    <!-- 1. 최신 접종일 조회 -->
    <select id="findLatestInjectionDate" resultType="java.time.LocalDate">
        SELECT MAX(injectionDate)
        FROM pet_vaccination
        WHERE petId = #{petId}
          AND vaccineName = #{vaccineName}
    </select>

    <!-- 2. 백신 주기 조회 -->
    <select id="findIntervalMonthsByVaccine" resultType="int">
        SELECT intervalMonths
        FROM vaccine_schedule
        WHERE vaccineName = #{vaccineName}
            LIMIT 1
    </select>

    <!-- 3. nextDueDate 일괄 업데이트 -->
    <update id="updateAllNextDueDates">
        UPDATE pet_vaccination
        SET nextDueDate = #{nextDueDate}
        WHERE petId = #{petId}
          AND vaccineName = #{vaccineName}
    </update>

</mapper>
